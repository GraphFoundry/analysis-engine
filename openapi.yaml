openapi: 3.1.0
info:
  title: Predictive Analysis Engine API
  summary: Predictive analysis for microservice failure and scaling scenarios
  description: |
    API for simulating failure and scaling scenarios in microservice call graphs.
    
    **Data Source:**
    - Graph Engine API (service-graph-engine) - single source of truth for topology and metrics
    
    **Note:** Swagger UI is disabled by default. Set `ENABLE_SWAGGER=true` to enable.
  version: 1.3.0
  contact:
    name: Team Alpha Zero
  license:
    identifier: ISC
    name: ISC

servers:
  - url: http://localhost:5000
    description: Local development server

externalDocs:
  description: Project documentation and usage guide
  url: https://github.com/Team-Alpha-Zero/predictive-analysis-engine

tags:
  - name: Health
    description: Health check and connectivity status
  - name: Simulation
    description: Failure and scaling simulation endpoints
  - name: Risk
    description: Risk analysis and centrality-based scoring
  - name: Services
    description: Service discovery endpoints
  - name: Telemetry
    description: Time-series metrics from InfluxDB
  - name: Decisions
    description: Decision logging and history
  - name: Graph
    description: Dependency graph snapshot with telemetry

paths:
  /health:
    get:
      tags:
        - Health
      summary: Health check endpoint
      description: Returns data source connectivity status and configuration info
      operationId: getHealth
      responses:
        '200':
          description: Health status response
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/HealthResponse'
              example:
                status: ok
                dataSource: graph-api
                provider:
                  connected: true
                  services: 12
                  stale: false
                  error: null
                graphApi:
                  enabled: true
                  available: true
                  status: ok
                  stale: false
                  lastUpdatedSecondsAgo: 45
                  baseUrl: http://service-graph-engine:8080
                  timeoutMs: 5000
                config:
                  maxTraversalDepth: 2
                  defaultLatencyMetric: p95
                  graphApiEnabled: true
                uptimeSeconds: 123.4
        '500':
          description: Internal server error
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
              example:
                status: error
                error: Connection failed

  /services:
    get:
      tags:
        - Services
      summary: List discovered services
      description: |
        Returns all services discovered in the current graph snapshot.
        Each service includes a normalized serviceId (namespace:name) for UI consumption.
        Includes freshness metadata from the graph engine.
        
        **Container-Level Metrics:**
        Each service includes placement information showing which Kubernetes nodes host its pods,
        along with pod-level resource metrics:
        - ramUsedMB: Pod RAM usage in MB (aggregated from all containers)
        - cpuUsagePercent: Pod CPU usage as percentage of node's total cores
        
        Node-level resource metrics (CPU and RAM) are also included for context.
      operationId: listServices
      responses:
        '200':
          description: List of services with freshness info
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ServicesListResponse'
              example:
                services:
                  - serviceId: "default:frontend"
                    name: "frontend"
                    namespace: "default"
                    podCount: 1
                    availability: 1
                    placement:
                      nodes:
                        - node: "minikube"
                          resources:
                            cpu:
                              usagePercent: 7.96
                              cores: 8
                            ram:
                              usedMB: 8107.19
                              totalMB: 24026.4
                          pods:
                            - name: "frontend-75d897db69-dmtzh"
                              ramUsedMB: 59.65
                              cpuUsagePercent: 0.27
                  - serviceId: "default:checkoutservice"
                    name: "checkoutservice"
                    namespace: "default"
                    podCount: 1
                    availability: 1
                    placement:
                      nodes:
                        - node: "minikube"
                          resources:
                            cpu:
                              usagePercent: 7.96
                              cores: 8
                            ram:
                              usedMB: 8107.19
                              totalMB: 24026.4
                          pods:
                            - name: "checkoutservice-57dd9cf79b-28dx6"
                              ramUsedMB: 52.06
                              cpuUsagePercent: 0.03
                count: 2
                stale: false
                lastUpdatedSecondsAgo: 45
                windowMinutes: 5
        '503':
          description: Graph Engine unavailable
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ServicesListResponse'
              example:
                error: "Graph Engine unreachable"
                services: []
                count: 0
                stale: true
                lastUpdatedSecondsAgo: null
                windowMinutes: 5

  /simulate/failure:
    post:
      tags:
        - Simulation
      summary: Simulate service failure
      description: |
        Simulate failure of a service and report the impact on upstream callers,
        downstream dependents, and potentially unreachable services.
        
        **Determinism Guarantee:** For the same input and graph snapshot, this endpoint
        returns identical results. The algorithm uses deterministic BFS traversal and
        fixed sorting criteria (no randomness).
        
        **Pipeline Trace:** Use `?trace=true` to include detailed execution trace in response.
      operationId: simulateFailure
      parameters:
        - name: trace
          in: query
          description: Enable pipeline trace (includes stage-by-stage execution details)
          required: false
          schema:
            type: boolean
            default: false
        - name: includeSnapshot
          in: query
          description: Include snapshot metadata in trace (requires trace=true)
          required: false
          schema:
            type: boolean
            default: false
        - name: includeRawPaths
          in: query
          description: Include raw path data structures in trace (requires trace=true)
          required: false
          schema:
            type: boolean
            default: false
        - name: includeEdgeDetails
          in: query
          description: Include detailed edge metadata in trace (requires trace=true)
          required: false
          schema:
            type: boolean
            default: false
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/FailureSimulationRequest'
            examples:
              byServiceId:
                summary: Using serviceId
                value:
                  serviceId: "default:frontend"
                  maxDepth: 2
              byNameNamespace:
                summary: Using name and namespace
                value:
                  name: frontend
                  namespace: default
                  maxDepth: 2
      responses:
        '200':
          description: Failure simulation result
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/FailureSimulationResponse'
              example:
                target:
                  serviceId: "default:frontend"
                  name: frontend
                  namespace: default
                neighborhood:
                  description: "k-hop neighborhood subgraph around target (not full graph)"
                  serviceCount: 8
                  edgeCount: 12
                  depthUsed: 2
                  generatedAt: "2024-01-15T10:30:00.000Z"
                dataFreshness:
                  source: graph-engine
                  stale: false
                  lastUpdatedSecondsAgo: 30
                  windowMinutes: 5
                confidence: high
                explanation: "If frontend fails, 3 upstream caller(s) lose direct access, 2 downstream service(s) lose traffic from this target, and 1 service(s) may become unreachable within the 2-hop neighborhood."
                affectedCallers:
                  - serviceId: "default:loadgenerator"
                    name: loadgenerator
                    namespace: default
                    lostTrafficRps: 150.5
                    edgeErrorRate: 0.02
                affectedDownstream:
                  - serviceId: "default:cartservice"
                    name: cartservice
                    namespace: default
                    lostTrafficRps: 100.0
                    edgeErrorRate: 0.01
                unreachableServices: []
                criticalPathsToTarget:
                  - path: ["default:loadgenerator", "default:frontend"]
                    pathRps: 150.5
                totalLostTrafficRps: 150.5
                recommendations:
                  - type: add_retry
                    priority: high
                    description: "Add retry logic for high-traffic callers"
        '400':
          description: Invalid request parameters
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
              example:
                error: "serviceId or (name + namespace) must be provided"
        '404':
          description: Service not found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
              example:
                error: "Service 'unknown-service' not found in graph"
        '503':
          description: Data source unavailable or stale
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
              example:
                error: "Graph data is stale (last update: 600s ago). Simulation results may be inaccurate."
        '504':
          description: Simulation timeout
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
              example:
                error: "Simulation timeout exceeded"
        '500':
          description: Internal server error
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
              example:
                error: "Internal server error"

  /simulate/add:
    post:
      tags:
        - Simulation
      summary: Simulate adding a new service
      description: |
        Analyze cluster capacity to determine if a new service with specified resource requirements
        can be added. Returns placement recommendations based on available node resources.
      operationId: simulateAdd
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/AddSimulationRequest'
            example:
              serviceName: new-service
              cpuRequest: 0.5
              ramRequest: 512
              replicas: 3
      responses:
        '200':
          description: Placement analysis result
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/AddSimulationResponse'
              example:
                success: true
                confidence: high
                explanation: "Successfully placed 3 replica(s) across 2 node(s)."
                totalCapacityPods: 10
                nodeAnalysis:
                  - node: minikube
                    cpuAvailable: 2.5
                    ramAvailableMB: 4096.0
                    canFit: true
                    maxPods: 5
                recommendation:
                  serviceName: new-service
                  cpuRequest: 0.5
                  ramRequest: 512
                  distribution:
                    - node: minikube
                      replicas: 3
        '400':
          description: Invalid request parameters
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '500':
          description: Internal server error
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

  /simulate/scale:
    post:
      tags:
        - Simulation
      summary: Simulate service scaling
      description: |
        Simulate scaling a service (changing pod count) and report the latency impact
        on upstream callers and critical paths.
        
        **Determinism Guarantee:** For the same input and graph snapshot, this endpoint
        returns identical results. The algorithm uses deterministic formulas and fixed
        traversal order (no randomness).
        
        **Scaling Models:**
        - **bounded_sqrt** (default): Realistic model with diminishing returns.
          Formula: `newLatency = baseLatency * (alpha + (1-alpha) / sqrt(ratio))`
          where ratio = newPods/currentPods, alpha = fixed overhead fraction (default 0.5).
          Result is clamped to minLatencyFactor * baseLatency (default 60% of baseline).
        - **linear**: Optimistic model assuming perfect scaling.
          Formula: `newLatency = baseLatency * (currentPods / newPods)`
          Useful for best-case estimates; no overhead assumption.
        
        **Pipeline Trace:** Use `?trace=true` to include detailed execution trace in response.
      operationId: simulateScale
      parameters:
        - name: trace
          in: query
          description: Enable pipeline trace (includes stage-by-stage execution details)
          required: false
          schema:
            type: boolean
            default: false
        - name: includeSnapshot
          in: query
          description: Include snapshot metadata in trace (requires trace=true)
          required: false
          schema:
            type: boolean
            default: false
        - name: includeRawPaths
          in: query
          description: Include raw path data structures in trace (requires trace=true)
          required: false
          schema:
            type: boolean
            default: false
        - name: includeEdgeDetails
          in: query
          description: Include detailed edge metadata in trace (requires trace=true)
          required: false
          schema:
            type: boolean
            default: false
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/ScalingSimulationRequest'
            examples:
              scaleUp:
                summary: Scale up from 2 to 4 pods
                value:
                  serviceId: "default:cartservice"
                  currentPods: 2
                  newPods: 4
                  latencyMetric: p95
                  maxDepth: 2
              withModel:
                summary: With custom scaling model
                value:
                  name: cartservice
                  namespace: default
                  currentPods: 2
                  targetPods: 6
                  latencyMetric: p99
                  model:
                    type: bounded_sqrt
                    alpha: 0.3
                  maxDepth: 2
      responses:
        '200':
          description: Scaling simulation result
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ScalingSimulationResponse'
              example:
                target:
                  serviceId: "default:cartservice"
                  name: cartservice
                  namespace: default
                neighborhood:
                  description: "k-hop upstream subgraph around target (not full graph)"
                  serviceCount: 5
                  edgeCount: 8
                  depthUsed: 2
                  generatedAt: "2024-01-15T10:30:00.000Z"
                dataFreshness:
                  source: graph-engine
                  stale: false
                  lastUpdatedSecondsAgo: 30
                  windowMinutes: 5
                confidence: high
                latencyMetric: p95
                scalingModel:
                  type: bounded_sqrt
                  alpha: 0.5
                currentPods: 2
                newPods: 4
                latencyEstimate:
                  description: "Rate-weighted mean of incoming edge latency to target"
                  baselineMs: 120.5
                  projectedMs: 85.2
                  deltaMs: -35.3
                  unit: milliseconds
                affectedCallers:
                  description: "Edge-level impact: deltaMs is change in this caller's direct outgoing edge latency. endToEndDeltaMs is cumulative path latency change."
                  items:
                    - serviceId: "default:frontend"
                      name: frontend
                      namespace: default
                      hopDistance: 1
                      beforeMs: 120.5
                      afterMs: 85.2
                      deltaMs: -35.3
                      endToEndBeforeMs: 120.5
                      endToEndAfterMs: 85.2
                      endToEndDeltaMs: -35.3
                      viaPath: ["default:frontend", "default:cartservice"]
                affectedPaths:
                  - path: ["default:frontend", "default:cartservice"]
                    pathRps: 100.0
                    beforeMs: 120.5
                    afterMs: 85.2
                    deltaMs: -35.3
                    incompleteData: false
                recommendations:
                  - type: scale_complete
                    priority: medium
                    description: "Scaling will improve latency by ~29%"
        '400':
          description: Invalid request parameters
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
              example:
                error: "currentPods must be a positive integer"
        '404':
          description: Service not found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
              example:
                error: "Service 'unknown-service' not found in graph"
        '503':
          description: Data source unavailable or stale
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '504':
          description: Simulation timeout
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '500':
          description: Internal server error
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

  /risk/services/top:
    get:
      tags:
        - Risk
      summary: Get top risk services
      description: |
        Get services ranked by risk based on centrality metrics (PageRank or betweenness).
        Higher centrality = higher risk if the service fails.
      operationId: getTopRiskServices
      parameters:
        - name: metric
          in: query
          description: Centrality metric to use for ranking
          required: false
          schema:
            type: string
            enum:
              - pagerank
              - betweenness
            default: pagerank
        - name: limit
          in: query
          description: Number of services to return (1-20)
          required: false
          schema:
            type: integer
            minimum: 1
            maximum: 20
            default: 5
      responses:
        '200':
          description: Top risk services
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/RiskAnalysisResponse'
              example:
                metric: pagerank
                services:
                  - serviceId: "default:frontend"
                    name: frontend
                    namespace: default
                    centralityScore: 0.2534
                    riskLevel: high
                    explanation: "frontend has high PageRank (0.2534), indicating it is a critical hub. Failure could cascade widely."
                  - serviceId: "default:cartservice"
                    name: cartservice
                    namespace: default
                    centralityScore: 0.1823
                    riskLevel: medium
                    explanation: "cartservice has moderate PageRank (0.1823). Monitor for dependencies."
                dataFreshness:
                  source: graph-engine
                  stale: false
                  lastUpdatedSecondsAgo: 30
                  windowMinutes: 5
                confidence: high
        '400':
          description: Invalid metric parameter
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
              example:
                error: "Invalid metric: invalid. Allowed: pagerank, betweenness"
        '503':
          description: Graph API not enabled
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
              example:
                error: "Graph API is not enabled"
        '500':
          description: Internal server error
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

  /telemetry/service:
    get:
      tags:
        - Telemetry
      summary: Get time-series metrics for a service
      description: |
        Retrieves time-series metrics for a specific service from InfluxDB 3.
        Maximum time range is 7 days. Returns data points bucketed by step interval.
        If service parameter is omitted, returns metrics for all services.
      operationId: getTelemetryService
      parameters:
        - name: service
          in: query
          required: false
          description: Service name to query metrics for (optional). If omitted, returns metrics for all services.
          schema:
            type: string
          example: productcatalogservice
        - name: from
          in: query
          required: true
          description: Start timestamp (ISO 8601)
          schema:
            type: string
            format: date-time
          example: '2026-01-04T10:00:00Z'
        - name: to
          in: query
          required: true
          description: End timestamp (ISO 8601)
          schema:
            type: string
            format: date-time
          example: '2026-01-04T11:00:00Z'
        - name: step
          in: query
          required: false
          description: Time bucket size in seconds (default 60)
          schema:
            type: integer
            default: 60
      responses:
        '200':
          description: Time-series metrics data
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/TelemetryServiceResponse'
        '400':
          description: Invalid parameters or time range exceeds limit
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '503':
          description: InfluxDB not configured
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

  /telemetry/edges:
    get:
      tags:
        - Telemetry
      summary: Get time-series metrics for edges
      description: |
        Retrieves time-series metrics for edges (calls between services) from InfluxDB 3.
        Maximum time range is 7 days. Can filter by source/destination service.
      operationId: getTelemetryEdges
      parameters:
        - name: fromService
          in: query
          required: false
          description: Source service name (optional filter)
          schema:
            type: string
        - name: toService
          in: query
          required: false
          description: Destination service name (optional filter)
          schema:
            type: string
        - name: from
          in: query
          required: true
          description: Start timestamp (ISO 8601)
          schema:
            type: string
            format: date-time
        - name: to
          in: query
          required: true
          description: End timestamp (ISO 8601)
          schema:
            type: string
            format: date-time
        - name: step
          in: query
          required: false
          description: Time bucket size in seconds (default 60)
          schema:
            type: integer
            default: 60
      responses:
        '200':
          description: Time-series edge metrics data
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/TelemetryEdgesResponse'
        '400':
          description: Invalid parameters or time range exceeds limit
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '503':
          description: InfluxDB not configured
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

  /decisions/log:
    post:
      tags:
        - Decisions
      summary: Log a decision from Pipeline Playground
      description: |
        Stores a decision record in SQLite for audit trail and analysis.
        Used by Pipeline Playground to log simulation decisions.
      operationId: logDecision
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/LogDecisionRequest'
            example:
              timestamp: '2026-01-04T10:00:00Z'
              type: failure
              scenario:
                serviceId: 'productcatalogservice'
                maxDepth: 2
              result:
                totalLostTrafficRps: 150.5
                affectedCallers: 5
              correlationId: 'abc-123-def'
      responses:
        '201':
          description: Decision logged successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/LogDecisionResponse'
        '400':
          description: Invalid request body
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '503':
          description: SQLite not configured or unavailable
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

  /api/dependency-graph/snapshot:
    get:
      tags:
        - Graph
      summary: Get enriched dependency graph snapshot with telemetry
      description: |
        Returns the complete dependency graph with enriched node and edge telemetry data.
        This endpoint is optimized for the Incident Explorer UI to provide comprehensive
        graph visualization data in a single request.
        
        **Node Data Includes:**
        - Service identity (id, name, namespace)
        - Risk level and reason (CRITICAL, HIGH, MEDIUM, LOW, UNKNOWN)
        - Aggregated telemetry metrics (request rate, error rate, latency, availability)
        
        **Edge Data Includes:**
        - Source and target service IDs
        - Optional edge telemetry (if available from Graph Engine)
        
        **Metadata Includes:**
        - Data freshness information
        - Last update timestamp
        - Total node and edge counts
      operationId: getDependencyGraphSnapshot
      parameters:
        - name: range
          in: query
          required: false
          description: Time range for metrics (informational only, currently not implemented)
          schema:
            type: string
            example: "1h"
        - name: namespace
          in: query
          required: false
          description: Filter nodes by namespace
          schema:
            type: string
            example: "default"
      responses:
        '200':
          description: Enriched graph snapshot with nodes, edges, and metadata
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/GraphSnapshotResponse'
              example:
                nodes:
                  - id: "default:frontend"
                    name: "frontend"
                    namespace: "default"
                    riskLevel: "LOW"
                    riskReason: "Operating normally"
                    reqRate: 150.5
                    errorRatePct: 0.2
                    latencyP95Ms: 45.3
                    availabilityPct: 99.9
                    updatedAt: "2026-01-04T10:00:00Z"
                  - id: "default:backend"
                    name: "backend"
                    namespace: "default"
                    riskLevel: "MEDIUM"
                    riskReason: "Elevated error rate (1.5%)"
                    reqRate: 200.0
                    errorRatePct: 1.5
                    latencyP95Ms: 120.0
                    availabilityPct: 99.5
                    updatedAt: "2026-01-04T10:00:00Z"
                edges:
                  - id: "default:frontend->default:backend"
                    source: "default:frontend"
                    target: "default:backend"
                    reqRate: 150.5
                    errorRatePct: 0.5
                    latencyP95Ms: 55.2
                metadata:
                  stale: false
                  lastUpdatedSecondsAgo: 30
                  windowMinutes: 5
                  nodeCount: 2
                  edgeCount: 1
                  generatedAt: "2026-01-04T10:00:00Z"
        '503':
          description: Graph Engine unavailable
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/GraphSnapshotErrorResponse'
              example:
                error: "Failed to fetch graph snapshot from Graph Engine"
                nodes: []
                edges: []
                metadata:
                  stale: true
                  lastUpdatedSecondsAgo: null
                  windowMinutes: 5

  /decisions/history:
    get:
      tags:
        - Decisions
      summary: Get decision history logs
      description: |
        Retrieves decision logs from SQLite with pagination and optional type filter.
        Returns most recent decisions first.
      operationId: getDecisionHistory
      parameters:
        - name: limit
          in: query
          required: false
          description: Page size (max 100, default 50)
          schema:
            type: integer
            default: 50
            maximum: 100
        - name: offset
          in: query
          required: false
          description: Pagination offset (default 0)
          schema:
            type: integer
            default: 0
        - name: type
          in: query
          required: false
          description: Filter by decision type (failure, scaling, risk)
          schema:
            type: string
            enum: [failure, scaling, risk]
      responses:
        '200':
          description: Decision history with pagination metadata
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/DecisionHistoryResponse'
        '503':
          description: SQLite not configured or unavailable
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

components:
  schemas:
    ErrorResponse:
      type: object
      description: Standard error response returned by all endpoints on failure
      required:
        - error
      example:
        error: "Service 'unknown-service' not found in graph"
      properties:
        error:
          type: string
          description: Human-readable error message describing what went wrong

    HealthResponse:
      type: object
      properties:
        status:
          type: string
          enum: [ok, degraded, error]
        dataSource:
          type: string
          enum: [graph-engine]
        provider:
          type: object
          properties:
            connected:
              type: boolean
            services:
              type: integer
            stale:
              type: boolean
            error:
              type: string
              nullable: true
        graphApi:
          type: object
          properties:
            enabled:
              type: boolean
            available:
              type: boolean
            status:
              type: string
            stale:
              type: boolean
            lastUpdatedSecondsAgo:
              type: number
            baseUrl:
              type: string
            timeoutMs:
              type: integer
            reason:
              type: string
        config:
          type: object
          properties:
            maxTraversalDepth:
              type: integer
            defaultLatencyMetric:
              type: string
            graphApiEnabled:
              type: boolean
        uptimeSeconds:
          type: number

    ServicesListResponse:
      type: object
      description: List of discovered services with freshness metadata
      properties:
        services:
          type: array
          description: List of services from the current graph snapshot
          items:
            $ref: '#/components/schemas/DiscoveredService'
        count:
          type: integer
          description: Total number of services discovered
          example: 12
        stale:
          type: boolean
          description: Whether the graph data is stale (older than expected window)
          example: false
        lastUpdatedSecondsAgo:
          type: number
          description: Seconds since last graph update (null if unavailable)
          nullable: true
          example: 45
        windowMinutes:
          type: number
          description: Expected freshness window in minutes
          example: 5
        error:
          type: string
          description: Error message if service discovery failed
          nullable: true

    DiscoveredService:
      type: object
      description: A service discovered in the graph with pod placement and container-level metrics
      required:
        - serviceId
        - name
        - namespace
      properties:
        serviceId:
          type: string
          description: "Canonical service ID in format 'namespace:name'"
          example: "default:frontend"
        name:
          type: string
          description: Service name
          example: "frontend"
        namespace:
          type: string
          description: Kubernetes namespace
          example: "default"
        podCount:
          type: integer
          description: Total number of pods running for this service
          example: 3
        availability:
          type: number
          description: Service availability score (0-1)
          example: 1
        placement:
          type: object
          description: Pod placement information across Kubernetes nodes with container-level resource metrics
          properties:
            nodes:
              type: array
              description: List of nodes hosting this service's pods
              items:
                type: object
                properties:
                  node:
                    type: string
                    description: Kubernetes node name
                    example: "minikube"
                  resources:
                    type: object
                    description: Node-level resource usage
                    properties:
                      cpu:
                        type: object
                        properties:
                          usagePercent:
                            type: number
                            description: Node CPU usage percentage
                            example: 7.96
                          cores:
                            type: integer
                            description: Total CPU cores available on node
                            example: 8
                      ram:
                        type: object
                        properties:
                          usedMB:
                            type: number
                            description: RAM used on node in MB
                            example: 8107.19
                          totalMB:
                            type: number
                            description: Total RAM available on node in MB
                            example: 24026.4
                  pods:
                    type: array
                    description: Pods running on this node with container-level metrics
                    items:
                      type: object
                      properties:
                        name:
                          type: string
                          description: Pod name
                          example: "frontend-75d897db69-dmtzh"
                        ramUsedMB:
                          type: number
                          description: Pod RAM usage in MB (aggregated from all containers)
                          example: 59.65
                        cpuUsagePercent:
                          type: number
                          description: Pod CPU usage as percentage of node's total cores
                          example: 0.27

    ServiceIdentifier:
      type: object
      description: Service can be identified by serviceId OR by name+namespace
      example:
        serviceId: "default:frontend"
        name: frontend
        namespace: default
      properties:
        serviceId:
          type: string
          description: "Canonical service ID in format 'namespace:name'"
          example: "default:frontend"
        name:
          type: string
          description: Service name (use with namespace)
          example: frontend
        namespace:
          type: string
          description: Kubernetes namespace (use with name)
          example: default

    FailureSimulationRequest:
      allOf:
        - $ref: '#/components/schemas/ServiceIdentifier'
        - type: object
          properties:
            maxDepth:
              type: integer
              minimum: 1
              maximum: 3
              default: 2
              description: Maximum traversal depth for impact analysis

    FailureSimulationResponse:
      type: object
      properties:
        target:
          $ref: '#/components/schemas/ServiceReference'
        neighborhood:
          $ref: '#/components/schemas/NeighborhoodInfo'
        dataFreshness:
          $ref: '#/components/schemas/DataFreshness'
        confidence:
          type: string
          enum: [high, low, unknown]
        explanation:
          type: string
        affectedCallers:
          type: array
          items:
            $ref: '#/components/schemas/AffectedCaller'
        affectedDownstream:
          type: array
          items:
            $ref: '#/components/schemas/AffectedDownstream'
        unreachableServices:
          type: array
          items:
            $ref: '#/components/schemas/UnreachableService'
        criticalPathsToTarget:
          type: array
          items:
            $ref: '#/components/schemas/CriticalPath'
        totalLostTrafficRps:
          type: number
        recommendations:
          type: array
          items:
            $ref: '#/components/schemas/Recommendation'
        pipelineTrace:
          $ref: '#/components/schemas/PipelineTrace'
          description: Optional pipeline trace (included only when trace=true query param is set)
        correlationId:
          type: string
          format: uuid
          description: Request correlation ID (included only when trace=true)

    ScalingSimulationRequest:
      allOf:
        - $ref: '#/components/schemas/ServiceIdentifier'
        - type: object
          required:
            - currentPods
          properties:
            currentPods:
              type: integer
              minimum: 1
              description: Current number of pods
            newPods:
              type: integer
              minimum: 1
              description: "Target number of pods (alias: targetPods, pods)"
            targetPods:
              type: integer
              minimum: 1
              description: Alias for newPods
            latencyMetric:
              type: string
              enum: [p50, p95, p99]
              default: p95
              description: Latency percentile to use
            model:
              $ref: '#/components/schemas/ScalingModel'
            maxDepth:
              type: integer
              minimum: 1
              maximum: 3
              default: 2
              description: Maximum traversal depth

    ScalingModel:
      type: object
      example:
        type: bounded_sqrt
        alpha: 0.5
      properties:
        type:
          type: string
          enum: [bounded_sqrt, linear]
          default: bounded_sqrt
          description: Scaling model type
        alpha:
          type: number
          minimum: 0
          maximum: 1
          default: 0.5
          description: Fixed overhead fraction (only for bounded_sqrt)

    ScalingSimulationResponse:
      type: object
      properties:
        target:
          $ref: '#/components/schemas/ServiceReference'
        neighborhood:
          $ref: '#/components/schemas/NeighborhoodInfo'
        dataFreshness:
          $ref: '#/components/schemas/DataFreshness'
        confidence:
          type: string
          enum: [high, low, unknown]
        latencyMetric:
          type: string
        scalingModel:
          $ref: '#/components/schemas/ScalingModel'
        currentPods:
          type: integer
        newPods:
          type: integer
        scalingDirection:
          type: string
          enum: [up, down, none]
          description: Direction of scaling (up if newPods > currentPods, down if less, none if equal)
        explanation:
          type: string
          description: Human-readable summary of scaling impact including latency change and affected callers
        latencyEstimate:
          $ref: '#/components/schemas/LatencyEstimate'
        affectedCallers:
          type: object
          properties:
            description:
              type: string
            items:
              type: array
              items:
                $ref: '#/components/schemas/AffectedCallerScaling'
        affectedPaths:
          type: array
          items:
            $ref: '#/components/schemas/AffectedPathScaling'
        warnings:
          type: array
          description: Present only when some paths have incomplete latency data
          items:
            type: string
        recommendations:
          type: array
          items:
            $ref: '#/components/schemas/Recommendation'
        pipelineTrace:
          $ref: '#/components/schemas/PipelineTrace'
          description: Optional pipeline trace (included only when trace=true query param is set)
        correlationId:
          type: string
          description: Request correlation ID (included only when trace=true)

    AddSimulationRequest:
      type: object
      required:
        - serviceName
      properties:
        serviceName:
          type: string
          description: Name of the service to add
        cpuRequest:
          type: number
          default: 0.1
          description: CPU cores requested per pod
        ramRequest:
          type: number
          default: 128
          description: RAM in MB requested per pod
        replicas:
          type: integer
          default: 1
          description: Number of replicas to deploy
        dependencies:
          type: array
          description: List of dependencies for the new service
          items:
            $ref: '#/components/schemas/ServiceDependency'

    ServiceDependency:
      type: object
      required:
        - serviceId
      properties:
        serviceId:
          type: string
        relation:
          type: string
          enum: [calls, called_by]
          default: calls

    AddSimulationResponse:
      type: object
      properties:
        targetServiceName:
          type: string
        success:
          type: boolean
          description: Whether the placement is possible for all replicas
        confidence:
          type: string
          enum: [high, low, unknown]
        explanation:
          type: string
          description: Human readable explanation of the result
        totalCapacityPods:
          type: integer
          description: Total number of such pods the cluster can fit
        suitableNodes:
          type: array
          items:
            $ref: '#/components/schemas/NodeSuitability'
        riskAnalysis:
          type: object
          properties:
            dependencyRisk:
              type: string
              enum: [low, medium, high]
            description:
              type: string
        recommendations:
          type: array
          items:
            $ref: '#/components/schemas/Recommendation'

    NodeSuitability:
      type: object
      properties:
        nodeName:
          type: string
        suitable:
          type: boolean
        reason:
          type: string
        availableCpu:
          type: number
        availableRam:
          type: number
        score:
          type: integer
          description: Suitability score (0-100)

    AddRecommendation:
      type: object
      properties:
        serviceName:
          type: string
        cpuRequest:
          type: number
        ramRequest:
          type: number
        distribution:
          type: array
          description: Recommended pod distribution
          items:
            type: object
            properties:
              node:
                type: string
              replicas:
                type: integer

    RiskAnalysisResponse:
      type: object
      properties:
        metric:
          type: string
          enum: [pagerank, betweenness]
        services:
          type: array
          items:
            $ref: '#/components/schemas/RiskService'
        dataFreshness:
          $ref: '#/components/schemas/DataFreshness'
        confidence:
          type: string
          enum: [high, low, unknown]

    RiskService:
      type: object
      properties:
        serviceId:
          type: string
        name:
          type: string
        namespace:
          type: string
        centralityScore:
          type: number
        riskLevel:
          type: string
          enum: [high, medium, low]
        explanation:
          type: string

    ServiceReference:
      type: object
      properties:
        serviceId:
          type: string
        name:
          type: string
        namespace:
          type: string

    NeighborhoodInfo:
      type: object
      properties:
        description:
          type: string
        serviceCount:
          type: integer
        edgeCount:
          type: integer
        depthUsed:
          type: integer
        generatedAt:
          type: string
          format: date-time

    DataFreshness:
      type: object
      nullable: true
      example:
        source: graph-engine
        stale: false
        lastUpdatedSecondsAgo: 30
        windowMinutes: 5
      properties:
        source:
          type: string
          description: Data source identifier (always 'graph-engine')
        stale:
          type: boolean
          description: Whether the data is considered stale
        lastUpdatedSecondsAgo:
          type: number
          description: Seconds since last data refresh
        windowMinutes:
          type: integer
          description: Data aggregation window in minutes

    AffectedCaller:
      type: object
      properties:
        serviceId:
          type: string
        name:
          type: string
        namespace:
          type: string
        lostTrafficRps:
          type: number
        edgeErrorRate:
          type: number

    AffectedDownstream:
      type: object
      properties:
        serviceId:
          type: string
        name:
          type: string
        namespace:
          type: string
        lostTrafficRps:
          type: number
        edgeErrorRate:
          type: number

    UnreachableService:
      type: object
      properties:
        serviceId:
          type: string
        name:
          type: string
        namespace:
          type: string
        lostTrafficRps:
          type: number
        lostFromTargetRps:
          type: number
        lostFromReachableCutsRps:
          type: number

    CriticalPath:
      type: object
      properties:
        path:
          type: array
          items:
            type: string
        pathRps:
          type: number

    AffectedCallerScaling:
      type: object
      properties:
        serviceId:
          type: string
        name:
          type: string
        namespace:
          type: string
        hopDistance:
          type: integer
        beforeMs:
          type: number
          nullable: true
        afterMs:
          type: number
          nullable: true
        deltaMs:
          type: number
          nullable: true
        endToEndBeforeMs:
          type: number
          nullable: true
        endToEndAfterMs:
          type: number
          nullable: true
        endToEndDeltaMs:
          type: number
          nullable: true
        viaPath:
          type: array
          nullable: true
          items:
            type: string

    AffectedPathScaling:
      type: object
      properties:
        path:
          type: array
          items:
            type: string
        pathRps:
          type: number
        beforeMs:
          type: number
          nullable: true
        afterMs:
          type: number
          nullable: true
        deltaMs:
          type: number
          nullable: true
        incompleteData:
          type: boolean

    LatencyEstimate:
      type: object
      properties:
        description:
          type: string
        baselineMs:
          type: number
          nullable: true
        projectedMs:
          type: number
          nullable: true
        deltaMs:
          type: number
          nullable: true
        unit:
          type: string

    Recommendation:
      type: object
      properties:
        type:
          type: string
        priority:
          type: string
          enum: [high, medium, low]
        description:
          type: string

    PipelineTrace:
      type: object
      description: Pipeline execution trace (included only when trace=true)
      properties:
        options:
          type: object
          description: Echo of trace options used
          properties:
            trace:
              type: boolean
            includeSnapshot:
              type: boolean
            includeRawPaths:
              type: boolean
            includeEdgeDetails:
              type: boolean
        stages:
          type: array
          description: Array of execution stages with timing information
          items:
            type: object
            properties:
              name:
                type: string
                description: Stage identifier (kebab-case)
              ms:
                type: number
                description: Duration in milliseconds
              summary:
                type: object
                description: Optional stage-specific metadata (size-limited)
                additionalProperties: true
              warnings:
                type: array
                description: Optional array of warning messages
                items:
                  type: string
        generatedAt:
          type: string
          format: date-time
          description: ISO 8601 timestamp when trace was finalized

    TelemetryServiceResponse:
      type: object
      description: Time-series metrics for a service
      required:
        - service
        - from
        - to
        - step
        - datapoints
      properties:
        service:
          type: string
        from:
          type: string
          format: date-time
        to:
          type: string
          format: date-time
        step:
          type: integer
        datapoints:
          type: array
          items:
            type: object
            properties:
              timestamp:
                type: string
                format: date-time
              service:
                type: string
              namespace:
                type: string
              requestRate:
                type: number
              errorRate:
                type: number
              p50:
                type: number
              p95:
                type: number
              p99:
                type: number
              availability:
                type: number

    TelemetryEdgesResponse:
      type: object
      description: Time-series metrics for edges
      required:
        - from
        - to
        - step
        - datapoints
      properties:
        fromService:
          type: string
        toService:
          type: string
        from:
          type: string
          format: date-time
        to:
          type: string
          format: date-time
        step:
          type: integer
        datapoints:
          type: array
          items:
            type: object
            properties:
              timestamp:
                type: string
                format: date-time
              from:
                type: string
              to:
                type: string
              namespace:
                type: string
              requestRate:
                type: number
              errorRate:
                type: number
              p50:
                type: number
              p95:
                type: number
              p99:
                type: number

    LogDecisionRequest:
      type: object
      description: Request to log a decision
      required:
        - timestamp
        - type
        - scenario
        - result
      properties:
        timestamp:
          type: string
          format: date-time
        type:
          type: string
          enum: [failure, scaling, risk]
        scenario:
          type: object
          additionalProperties: true
        result:
          type: object
          additionalProperties: true
        correlationId:
          type: string

    LogDecisionResponse:
      type: object
      description: Response after logging a decision
      required:
        - id
        - timestamp
      properties:
        id:
          type: integer
        timestamp:
          type: string
          format: date-time

    DecisionHistoryResponse:
      type: object
      description: Decision history with pagination
      required:
        - decisions
        - pagination
      properties:
        decisions:
          type: array
          items:
            type: object
            properties:
              id:
                type: integer
              timestamp:
                type: string
                format: date-time
              type:
                type: string
              scenario:
                type: object
                additionalProperties: true
              result:
                type: object
                additionalProperties: true
              correlationId:
                type: string
                nullable: true
              createdAt:
                type: string
                format: date-time
        pagination:
          type: object
          properties:
            limit:
              type: integer
            offset:
              type: integer
            total:
              type: integer
    GraphNode:
      type: object
      description: Enriched graph node with telemetry
      required:
        - id
        - name
        - namespace
        - riskLevel
      properties:
        id:
          type: string
          description: Unique node identifier (namespace:name)
          example: "default:frontend"
        name:
          type: string
          description: Service name
          example: "frontend"
        namespace:
          type: string
          description: Kubernetes namespace
          example: "default"
        riskLevel:
          type: string
          enum: [CRITICAL, HIGH, MEDIUM, LOW, UNKNOWN]
          description: Calculated risk level based on metrics
        riskReason:
          type: string
          description: Human-readable explanation of risk level
          example: "High error rate (6.2%)"
        reqRate:
          type: number
          description: Requests per second
          example: 150.5
        errorRatePct:
          type: number
          description: Error rate as percentage
          example: 0.2
        latencyP95Ms:
          type: number
          description: 95th percentile latency in milliseconds
          example: 45.3
        availabilityPct:
          type: number
          description: Availability percentage
          example: 99.9
        updatedAt:
          type: string
          format: date-time
          description: Timestamp of last metric update

    GraphEdge:
      type: object
      description: Enriched graph edge with optional telemetry
      required:
        - id
        - source
        - target
      properties:
        id:
          type: string
          description: Unique edge identifier
          example: "default:frontend->default:backend"
        source:
          type: string
          description: Source node ID (namespace:name)
          example: "default:frontend"
        target:
          type: string
          description: Target node ID (namespace:name)
          example: "default:backend"
        reqRate:
          type: number
          description: Requests per second on this edge
          example: 150.5
        errorRatePct:
          type: number
          description: Error rate as percentage on this edge
          example: 0.5
        latencyP95Ms:
          type: number
          description: 95th percentile latency in milliseconds on this edge
          example: 55.2

    GraphSnapshotMetadata:
      type: object
      description: Metadata about graph snapshot freshness and size
      properties:
        stale:
          type: boolean
          description: Whether the graph data is stale
        lastUpdatedSecondsAgo:
          type: number
          nullable: true
          description: Seconds since last update from Graph Engine
        windowMinutes:
          type: integer
          description: Metrics aggregation window in minutes
        nodeCount:
          type: integer
          description: Total number of nodes in snapshot
        edgeCount:
          type: integer
          description: Total number of edges in snapshot
        generatedAt:
          type: string
          format: date-time
          description: Timestamp when snapshot was generated

    GraphSnapshotResponse:
      type: object
      description: Complete dependency graph snapshot with enriched telemetry
      required:
        - nodes
        - edges
      properties:
        nodes:
          type: array
          items:
            $ref: '#/components/schemas/GraphNode'
        edges:
          type: array
          items:
            $ref: '#/components/schemas/GraphEdge'
        metadata:
          $ref: '#/components/schemas/GraphSnapshotMetadata'

    GraphSnapshotErrorResponse:
      type: object
      description: Error response when graph snapshot cannot be fetched
      required:
        - error
        - nodes
        - edges
        - metadata
      properties:
        error:
          type: string
          description: Error message
        nodes:
          type: array
          items:
            $ref: '#/components/schemas/GraphNode'
          description: Empty array on error
        edges:
          type: array
          items:
            $ref: '#/components/schemas/GraphEdge'
          description: Empty array on error
        metadata:
          $ref: '#/components/schemas/GraphSnapshotMetadata'